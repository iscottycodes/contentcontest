#!/usr/bin/env node

/**
 * Firebase Setup Automation Script
 * 
 * This script helps automate the Firebase setup process.
 * It validates environment variables and provides helpful guidance.
 */

const fs = require('fs');
const path = require('path');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

const question = (query) => new Promise((resolve) => rl.question(query, resolve));

const ENV_LOCAL_PATH = path.join(process.cwd(), '.env.local');
const ENV_EXAMPLE_PATH = path.join(process.cwd(), 'env.example');

// Required environment variables
const REQUIRED_VARS = [
  'NEXT_PUBLIC_FIREBASE_API_KEY',
  'NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN',
  'NEXT_PUBLIC_FIREBASE_PROJECT_ID',
  'NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET',
  'NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID',
  'NEXT_PUBLIC_FIREBASE_APP_ID',
];

function checkEnvFile() {
  if (fs.existsSync(ENV_LOCAL_PATH)) {
    const envContent = fs.readFileSync(ENV_LOCAL_PATH, 'utf8');
    const envVars = {};
    
    envContent.split('\n').forEach(line => {
      const trimmed = line.trim();
      if (trimmed && !trimmed.startsWith('#')) {
        const [key, ...valueParts] = trimmed.split('=');
        if (key && valueParts.length > 0) {
          envVars[key.trim()] = valueParts.join('=').trim();
        }
      }
    });

    const missing = REQUIRED_VARS.filter(varName => {
      const value = envVars[varName];
      return !value || value.includes('your-') || value === '';
    });

    if (missing.length === 0) {
      console.log('âœ… .env.local file exists and all variables are set!');
      return true;
    } else {
      console.log(`âš ï¸  .env.local exists but has missing/incomplete variables:`);
      missing.forEach(v => console.log(`   - ${v}`));
      return false;
    }
  } else {
    console.log('âŒ .env.local file not found');
    return false;
  }
}

async function createEnvFile() {
  console.log('\nğŸ“ Let\'s create your .env.local file!\n');
  console.log('You can get these values from:');
  console.log('ğŸ‘‰ https://console.firebase.google.com/project/_/settings/general\n');
  console.log('(Look for "Your apps" section and click the web app icon)\n');

  const envVars = {};

  for (const varName of REQUIRED_VARS) {
    const friendlyName = varName.replace('NEXT_PUBLIC_FIREBASE_', '').replace(/_/g, ' ').toLowerCase();
    const answer = await question(`Enter ${friendlyName}: `);
    envVars[varName] = answer.trim();
  }

  // Create .env.local file
  let envContent = '# Firebase Configuration\n';
  envContent += '# Generated by setup-firebase.js\n\n';
  
  REQUIRED_VARS.forEach(varName => {
    envContent += `${varName}=${envVars[varName]}\n`;
  });

  fs.writeFileSync(ENV_LOCAL_PATH, envContent);
  console.log('\nâœ… .env.local file created successfully!');
}

function printNextSteps() {
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ“‹ NEXT STEPS - Manual Setup Required');
  console.log('='.repeat(60));
  console.log('\n1. Create Firebase Project:');
  console.log('   ğŸ‘‰ https://console.firebase.google.com/');
  console.log('\n2. Enable Authentication (Email/Password):');
  console.log('   ğŸ‘‰ https://console.firebase.google.com/project/_/authentication');
  console.log('\n3. Create Firestore Database:');
  console.log('   ğŸ‘‰ https://console.firebase.google.com/project/_/firestore');
  console.log('   â†’ Choose "Start in test mode" (we\'ll secure it later)');
  console.log('\n4. Enable Storage:');
  console.log('   ğŸ‘‰ https://console.firebase.google.com/project/_/storage');
  console.log('\n5. Get Firebase Config (already done if you filled .env.local):');
  console.log('   ğŸ‘‰ https://console.firebase.google.com/project/_/settings/general');
  console.log('\n6. Create Admin User:');
  console.log('   ğŸ‘‰ https://console.firebase.google.com/project/_/authentication/users');
  console.log('   â†’ Click "Add user" and create admin@contentcontest.ca');
  console.log('\n7. Deploy Security Rules:');
  console.log('   Run: npm run firebase:deploy-rules');
  console.log('   (Or manually copy rules from firestore.rules and storage.rules)');
  console.log('\n8. Restart dev server:');
  console.log('   npm run dev');
  console.log('\n' + '='.repeat(60));
}

async function main() {
  console.log('\nğŸ”¥ Firebase Setup Automation\n');
  console.log('='.repeat(60));

  const envExists = checkEnvFile();

  if (!envExists) {
    const create = await question('\nWould you like to create .env.local now? (y/n): ');
    if (create.toLowerCase() === 'y' || create.toLowerCase() === 'yes') {
      await createEnvFile();
    } else {
      console.log('\nâš ï¸  You can create .env.local manually by copying env.example');
      console.log('   Make sure to fill in all your Firebase config values!');
    }
  }

  printNextSteps();

  rl.close();
}

main().catch(console.error);
